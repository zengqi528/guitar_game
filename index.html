<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Guitar Fret Game</title>
    <!-- ç¡®ä¿æ²¡æœ‰å¼•ç”¨ä¸å­˜åœ¨çš„CSS/JSæ–‡ä»¶ -->

    <style>
        /* --- åŸºç¡€æ ·å¼ --- */
        body {
            margin: 0; padding: 0;
            font-family: -apple-system, sans-serif;
            background-color: #f8f9fa;
            height: 100vh; overflow: hidden;
            user-select: none; -webkit-user-select: none;
            display: flex; flex-direction: column;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }

        /* --- é®ç½©å±‚ (æœ€é‡è¦) --- */
        #start-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; z-index: 9999;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }

        .big-btn {
            background: #007aff; color: white;
            border: none; padding: 20px 60px;
            font-size: 24px; border-radius: 50px;
            font-weight: bold; margin-top: 30px;
            box-shadow: 0 10px 20px rgba(0,122,255,0.3);
        }
        .big-btn:active { background: #0051a8; transform: scale(0.95); }

        /* --- æ¸¸æˆåŒºåŸŸ --- */
        header {
            height: 60px; padding: 0 20px;
            padding-top: env(safe-area-inset-top);
            background: rgba(255,255,255,0.9);
            border-bottom: 1px solid #ccc;
            display: flex; justify-content: space-between; align-items: center;
        }

        #game-area {
            flex: 1; display: flex; flex-direction: column; justify-content: center;
            background: #f0f0f5; position: relative;
        }

        /* æŒ‡æ¿ */
        #scroll-view {
            width: 100%; overflow-x: auto; padding: 30px 0;
            display: flex; justify-content: center;
        }
        #board {
            position: relative; min-width: 900px; height: 220px;
            background: #e4d0a6; border-top: 5px solid #d4c095; border-bottom: 5px solid #d4c095;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            margin: 0 20px;
        }
        .fret { position: absolute; top: 0; bottom: 0; width: 3px; background: #c0c0c0; }
        .string { position: absolute; left: 0; right: 0; background: #999; pointer-events: none; }
        .dot { position: absolute; width: 16px; height: 16px; background: #222; border-radius: 50%; opacity: 0.8; transform: translate(-50%, -50%); top: 50%; }
        
        /* çº¢ç‚¹ */
        #marker {
            position: absolute; width: 30px; height: 30px;
            background: #ff3b30; border: 3px solid white; border-radius: 50%;
            transform: translate(-50%, -50%); display: none;
            box-shadow: 0 0 10px #ff3b30; transition: left 0.3s, top 0.3s;
            z-index: 100;
        }
        #marker.ok { background: #34c759; box-shadow: 0 0 15px #34c759; }

        /* æŒ‰é’®åŒº */
        #keypad {
            padding: 10px; padding-bottom: calc(20px + env(safe-area-inset-bottom));
            background: #fff; display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px;
        }
        .key {
            height: 55px; background: #fff; border: 1px solid #ddd;
            border-bottom: 3px solid #ddd; border-radius: 8px;
            font-size: 18px; font-weight: bold; color: #333;
        }
        .key:active { transform: translateY(2px); border-bottom: 1px solid #ddd; background: #eee; }
    </style>
</head>
<body>

    <!-- 1. å¯åŠ¨ç•Œé¢ -->
    <div id="start-screen">
        <h1 style="font-size: 32px; margin-bottom: 10px;">ğŸ¸ æŒ‡æ¿å¤§å¸ˆ</h1>
        <p id="status-text" style="color: #666;">ç³»ç»ŸåŠ è½½ä¸­...</p>
        <button id="btn-play" class="big-btn" style="display:none;">å¼€å§‹æŒ‘æˆ˜</button>
    </div>

    <!-- 2. æ¸¸æˆç•Œé¢ -->
    <header>
        <div>å¾—åˆ†: <b id="score">0</b></div>
        <div style="text-align:right; font-size: 12px; color:#888;">æœ€é«˜åˆ†<br><b id="hiscore" style="font-size:16px; color:#007aff;">0</b></div>
    </header>

    <div id="game-area">
        <div id="scroll-view">
            <div id="board">
                <div id="marker"></div>
            </div>
        </div>
    </div>

    <div id="keypad"></div>

<script>
    // --- é€»è¾‘éƒ¨åˆ† ---
    
    // å…¨å±€å˜é‡
    var ctx = null; // AudioContext
    var score = 0;
    var hiscore = 0;
    var currentQ = null;
    var isLock = false;

    // æ•°æ®
    var NOTES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
    var BASES = [4, 11, 7, 2, 9, 4]; // 6æ ¹å¼¦ç©ºå¼¦éŸ³ç¨‹

    // 1. é¡µé¢åŠ è½½å®Œæˆåæ‰è¿è¡Œï¼Œé˜²æ­¢ç™½å±
    window.onload = function() {
        console.log("Page Loaded");
        
        // æ˜¾ç¤ºæŒ‰é’®
        document.getElementById('status-text').innerText = "å‡†å¤‡å°±ç»ª";
        document.getElementById('btn-play').style.display = "block";

        // åˆå§‹åŒ–UI
        initBoard();
        initKeys();
        loadScore();

        // ç»‘å®šå¼€å§‹æŒ‰é’®
        var btn = document.getElementById('btn-play');
        btn.addEventListener('touchstart', startGame, {passive: false});
        btn.addEventListener('click', startGame);
    };

    // 2. å¼€å§‹æ¸¸æˆ (æ ¸å¿ƒï¼šåœ¨è¿™é‡Œåˆå§‹åŒ–éŸ³é¢‘)
    function startGame(e) {
        if(e) { e.preventDefault(); e.stopPropagation(); }

        // éšè—é®ç½©
        document.getElementById('start-screen').style.display = 'none';

        // åˆå§‹åŒ–éŸ³é¢‘ (å¿…é¡»åœ¨ç‚¹å‡»äº‹ä»¶é‡Œ)
        try {
            var AudioContext = window.AudioContext || window.webkitAudioContext;
            if (AudioContext) {
                ctx = new AudioContext();
                ctx.resume(); // iOS å¼ºåˆ¶ resume
            }
        } catch(err) {
            console.error(err);
        }

        // å‡ºç¬¬ä¸€é¢˜
        nextQuestion();
    }

    // 3. æ’­æ”¾å£°éŸ³
    function playSound(s, f) {
        if (!ctx) return;
        try {
            var t = ctx.currentTime;
            var osc = ctx.createOscillator();
            var g = ctx.createGain();
            
            // é¢‘ç‡è®¡ç®—
